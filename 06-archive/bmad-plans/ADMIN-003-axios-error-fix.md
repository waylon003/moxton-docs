# Tech-Spec: Axios请求封装错误提示修复

**创建时间:** 2025-12-12
**状态:** 准备开发
**优先级:** 高 - 影响用户体验

## 概述

### 问题陈述

当前axios请求封装存在多个错误提示相关的问题，导致用户体验不佳：

1. **重复错误提示**: 同一个错误会触发多个弹窗
2. **字段名不匹配**: 后端返回`message`字段，但前端读取`msg`字段
3. **错误信息不准确**: 显示的不是后端返回的具体错误信息
4. **500错误处理缺失**: 服务器内部错误没有正确分类处理

### 解决方案

修复`src/service/request/index.ts`中的错误处理逻辑，确保：
- 只在适当的时机显示一次错误消息
- 正确读取后端返回的错误信息字段
- 完善500等服务器错误的处理策略

### 范围 (包含/不包含)

**包含:**
- ✅ 修复`src/service/request/index.ts`的错误处理逻辑
- ✅ 统一错误消息字段名读取 (`message`)
- ✅ 避免重复错误提示
- ✅ 完善500错误处理
- ✅ 优化错误提示去重机制

**不包含:**
- ❌ 组件级别的错误处理逻辑
- ❌ 后端API响应格式修改
- ❌ 错误提示UI样式修改

## 开发上下文

### 代码库模式

#### 错误处理架构
- 使用自定义axios封装 (`@sa/axios`)
- 支持多种错误处理钩子: `onError`, `onBackendFail`
- 错误消息去重机制: `errMsgStack`

#### API响应格式
```json
{
  "code": 200 | 500 | 401 | 403 | 404,
  "message": "错误信息描述",
  "data": {} | null,
  "success": true | false
}
```

### 文件引用

**核心文件:**
- `src/service/request/index.ts` - 主要的请求配置文件
- `src/service/request/shared.ts` - 共享工具函数
- `packages/axios/src/index.ts` - 底层axios封装

**相关组件:**
- `src/views/category/index.vue` - 涉及错误处理的组件示例

### 技术决策

#### 错误处理策略
- **HTTP状态码错误**: 由axios自动处理，进入`onError`钩子
- **业务逻辑错误**: 由`isBackendSuccess`判断，进入`onBackendFail`钩子
- **网络错误**: 直接进入`onError`钩子

#### 错误消息优先级
1. 后端返回的具体错误信息 (`response.data.message`)
2. axios默认错误信息 (`error.message`)
3. 通用错误提示

## 实现计划

### 任务

- [ ] **任务1**: 修复字段名读取问题 (`msg` → `message`)
- [ ] **任务2**: 优化`onError`钩子，避免重复提示
- [ ] **任务3**: 完善`onBackendFail`钩子，处理服务器错误
- [ ] **任务4**: 测试各种错误场景
- [ ] **任务5**: 验证错误提示去重机制

### 验收标准

- [ ] **AC1**: Given 后端返回500错误时，When 请求失败，Then 只显示一次后端返回的`message`字段内容
- [ ] **AC2**: Given 后端返回业务错误时，When code≠200，Then 由`onBackendFail`处理，不触发`onError`
- [ ] **AC3**: Given 网络错误时，When 请求失败，Then 显示axios默认错误信息，不重复提示
- [ ] **AC4**: Given 相同错误消息时，When 多次发生，Then 只显示一个提示，使用去重机制
- [ ] **AC5**: Given 各种错误场景时，When 测试，Then 错误信息准确反映后端返回内容

## 附加上下文

### 依赖关系

**前置依赖:**
- 无

**后置影响:**
- 所有使用API请求的组件都会受益于修复
- 错误提示行为变化，需要测试覆盖

### 测试策略

#### 测试场景
1. **服务器错误 (500)**: 验证错误信息准确性和单次显示
2. **业务错误 (400/401/403)**: 验证由正确的钩子处理
3. **网络错误**: 验证网络问题的错误提示
4. **重复错误**: 验证去重机制正常工作
5. **不同API接口**: 验证修复适用于所有API调用

#### 测试方法
- 手动测试category页面的删除操作
- 使用开发者工具模拟各种错误响应
- 检查控制台错误和用户提示的一致性

### 注意事项

#### 环境变量配置
确保以下环境变量正确配置:
```bash
VITE_SERVICE_SUCCESS_CODE=200
VITE_SERVICE_LOGOUT_CODES=401,403
VITE_SERVICE_MODAL_LOGOUT_CODES=
VITE_SERVICE_EXPIRED_TOKEN_CODES=401
```

#### 兼容性考虑
- 保持现有API调用方式不变
- 不影响现有的认证和授权流程
- 保持错误消息去重机制的有效性

#### 性能影响
- 修改主要优化错误处理逻辑，对性能影响微乎其微
- 减少重复弹窗可以提升用户体验

## 实施细节

### 修复点分析

#### 1. 字段名修复 (关键)
**位置**: `src/service/request/index.ts:109`
```typescript
// 修复前
message = error.response?.data?.msg || message;

// 修复后
message = error.response?.data?.message || message;
```

#### 2. 错误处理流程优化 (关键)
**问题**: `onBackendFail` 和 `onError` 都可能显示错误消息
**解决**: 明确分工，避免重复

#### 3. 500错误处理 (重要)
**当前问题**: 500错误被当作网络错误处理
**解决方案**: 在`onBackendFail`中添加500错误的特殊处理

### 代码修改策略

#### 分阶段实施
1. **第一阶段**: 修复字段名，确保错误信息正确读取
2. **第二阶段**: 优化错误处理流程，避免重复提示
3. **第三阶段**: 完善500等服务器错误处理
4. **第四阶段**: 全面测试验证

每个阶段都可以独立测试和验证。

---

**下一步**: 建议使用`/quick-dev`工作流在 fresh context 中实施此技术规格，确保最佳开发效果。