# Tech-Spec: Offline Orders 业务流程增强

**创建时间:** 2025-12-15
**状态:** Ready for Development
**优先级:** P1 - 高优先级

## 概述

### 问题陈述

基于后台管理系统现状分析和专家团队讨论，当前 offline-orders 模块存在以下关键问题：

**P0 - 阻塞性问题:**
1. **订单状态更新功能缺失** - 后端接口 `PUT /api/offline-orders/admin/:id` 存在但前端无法正常调用，导致管理员无法更新订单状态
2. **管理员记录填写功能缺失** - 管理员无法添加处理备注和跟进记录
3. **操作历史回溯功能缺失** - 无法追踪订单处理过程和操作记录

**P1 - 体验性问题:**
4. **业务流程不够完整** - 缺乏完整的咨询订单处理工作流
5. **权限模型设计不当** - 现有的 `assignedTo` 字段造成不必要的管理员分配限制

### 解决方案

基于专家团队讨论的优化方案，增强 offline-orders 模块的业务流程管理功能：

**核心设计原则:**
- **共享管理员权限** - 所有管理员都可以操作任何咨询订单，无需分配
- **自动操作追踪** - 每次操作自动记录管理员ID、时间、操作内容
- **合并接口设计** - 状态更新和记录填写合并为单一接口，提高操作效率

**关键功能实现:**
1. **修复状态更新接口** - 确保 PUT /api/offline-orders/admin/:id 接口正常工作
2. **合并管理员操作** - 状态更新 + 记录填写集成为单一接口
3. **实现历史记录系统** - 完整的操作追踪和回溯功能
4. **优化权限模型** - 移除冗余的 `assignedTo` 字段，支持共享管理

### 范围界定

**范围内:**
- 验证和修复现有状态更新接口
- 扩展订单状态定义和流转逻辑
- 添加跟进提醒和优先级管理
- 增强管理员操作功能
- 优化 API 响应和错误处理
- 更新 API 文档和测试

**范围外:**
- 前端界面开发
- 邮件/短信通知系统（只预留接口）
- 财务系统集成
- 第三方 CRM 集成

## 开发上下文

### 代码库模式

**现有架构模式:**
- MVC 架构：Model → Controller → Route
- 混合认证：`optionalAuthMiddleware` + `adminMiddleware`
- 统一响应格式：`ctx.success()`, `ctx.badRequest()` 等
- 逻辑删除：`isDeleted` 字段支持
- 分页查询：标准的 `pageNum`/`pageSize` 模式

**关键文件:**
- `src/models/OfflineOrder.ts` - 数据访问层，继承 BaseModel
- `src/controllers/OfflineOrder.ts` - 业务逻辑层，14个控制器方法
- `src/routes/offline-orders.ts` - 路由定义，完整的用户端+管理端接口
- `prisma/schema.prisma` - 数据库表结构，OfflineOrder 表定义

### 需要参考的文件

**核心模型:**
- `src/models/base.ts` - BaseModel CRUD 操作
- `src/models/Order.ts` - 普通订单的状态管理参考
- `src/models/Cart.ts` - 购物车的混合认证参考

**控制器模式:**
- `src/controllers/Product.ts` - 批量操作参考
- `src/controllers/Order.ts` - 状态更新参考
- `src/controllers/Cart.ts` - 混合认证参考

**中间件和工具:**
- `src/middleware/auth.ts` - 认证中间件
- `src/utils/validation.ts` - 参数验证工具
- `src/middleware/admin.ts` - 管理员权限验证

### 技术决策

1. **保持现有架构一致性** - 继续使用现有的 MVC 模式和响应格式
2. **向后兼容** - 新增功能不破坏现有 API
3. **渐进式增强** - 分阶段实施，先修复问题，再添加新功能
4. **数据库最小变更** - 优先使用现有字段，必要时添加新字段

## 实施计划

### 任务

**P0 - 阻塞性功能修复**

- [ ] **任务 1: 验证和修复状态更新接口**
  - 验证 PUT /api/offline-orders/admin/:id 接口的实际可用性
  - 检查路由注册、权限中间件配置
  - 修复前端对接问题或后端接口问题
  - 确保接口响应格式符合前端预期

- [ ] **任务 2: 实现合并的管理员操作接口**
  - 优化 `updateOfflineOrderStatus` 方法，支持状态+备注同时更新
  - 移除冗余的 `assignedTo` 字段，支持共享管理员权限
  - 实现可选字段更新逻辑（status 和 adminNotes 都可选）
  - 确保数据库事务一致性

**P1 - 历史记录系统**

- [ ] **任务 3: 实现完整的操作历史追踪**
  - 设计并创建 `offlineOrderHistory` 数据表
  - 自动记录每次操作的管理员ID、操作时间、变更内容
  - 实现状态变更的完整追踪（oldStatus → newStatus）
  - 记录管理员备注和处理记录

- [ ] **任务 4: 实现历史记录查询接口**
  - 添加 GET /api/offline-orders/admin/:id/history 接口
  - 支持按时间排序的操作历史查询
  - 包含管理员信息、操作类型、变更内容的完整记录
  - 优化查询性能，添加适当的数据库索引

### 验收标准

**P0 功能验收:**

- [ ] **AC 1: Given** 管理员已登录，**When** 访问 PUT /api/offline-orders/admin/:id 更新状态，**Then** 订单状态成功更新并返回最新订单信息
- [ ] **AC 2: Given** 管理员已登录，**When** 使用同一接口添加管理员备注，**Then** 备注成功保存并返回更新后的订单
- [ ] **AC 3: Given** 管理员已登录，**When** 同时更新状态和备注，**Then** 两个字段都正确更新，操作在同一事务中完成
- [ ] **AC 4: Given** 非管理员用户，**When** 尝试访问管理接口，**Then** 返回 403 权限错误
- [ ] **AC 5: Given** 无效状态值，**When** 尝试更新状态，**Then** 返回适当的验证错误信息

**P1 历史记录验收:**

- [ ] **AC 6: Given** 管理员更新订单状态，**When** 查询操作历史，**Then** 能看到完整的操作记录，包括管理员信息、时间、状态变更
- [ ] **AC 7: Given** 管理员添加处理备注，**When** 查询操作历史，**Then** 备注内容被正确记录并可查询
- [ ] **AC 8: Given** 订单有多次操作历史，**When** 调用历史查询接口，**Then** 返回按时间倒序排列的完整操作列表
- [ ] **AC 9: Given** 新增功能，**When** 调用相关 API，**Then** 响应格式与现有接口保持完全一致

**回归测试验收:**

- [ ] **AC 10: Given** 所有修改完成，**When** 测试现有功能，**Then** 订单列表、详情、删除等功能不受影响
- [ ] **AC 11: Given** 游客和普通用户，**When** 使用用户端接口，**Then** 功能完全正常且不受管理功能影响

## 附加上下文

### 依赖关系

**系统依赖:**
- Koa.js Web 框架和中间件
- Prisma ORM 和 MySQL 数据库
- JWT 认证系统
- 现有的用户和权限管理系统

**模块依赖:**
- Products 模块（商品信息获取）
- Users 模块（用户信息和管理员验证）
- Notifications 模块（通知功能预留）

### 测试策略

**单元测试:**
- 模型层的状态验证逻辑
- 控制器层的业务规则验证
- 中间件的权限和认证验证

**集成测试:**
- API 端点的完整流程测试
- 数据库操作的验证
- 权限和安全性测试

**回归测试:**
- 确保现有功能不受影响
- 验证 API 兼容性
- 性能基准测试

### 注意事项

**数据安全:**
- 管理员操作需要完整的权限验证
- 敏感信息（用户数据）需要适当保护
- 操作日志需要完整记录

**性能考虑:**
- 批量操作需要适当的限制和分页
- 数据库查询需要优化索引
- 响应时间需要控制在合理范围内

**扩展性:**
- 状态枚举设计需要考虑未来扩展
- 接口设计需要支持版本控制
- 预留第三方集成接口

## 风险和缓解措施

**技术风险:**
- **数据库 schema 变更** → 使用 Prisma migrate 安全执行
- **现有 API 兼容性** → 保持严格的向后兼容
- **性能影响** → 实施适当的数据库索引和查询优化

**业务风险:**
- **功能复杂性** → 分阶段实施，逐步验证
- **用户接受度** → 充分的文档和培训支持
- **数据一致性** → 完整的测试覆盖和回滚计划

---

**此技术规格为 offline-orders 模块的增强功能提供完整的实施指导，确保在保持现有功能稳定的基础上，显著提升业务流程管理能力。**